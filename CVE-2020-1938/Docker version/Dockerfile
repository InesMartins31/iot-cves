FROM ubuntu:18.04
ARG DEBIAN_FRONTEND=noninteractive
WORKDIR /root
RUN apt-get update && apt-get install -y default-jdk wget unzip
RUN groupadd tomcat
RUN useradd -s /bin/false -g tomcat -d /opt/tomcat tomcat

RUN wget https://github.com/0nise/CVE-2020-1938/raw/master/apache-tomcat-8.5.32.zip && \
    unzip apache-tomcat-8.5.32.zip && \
    mv apache-tomcat-8.5.32 /opt/tomcat && \
    chgrp -R tomcat /opt/tomcat && \
    chmod -R g+r /opt/tomcat/conf && \
    chmod g+x /opt/tomcat/conf && \
    chown -R tomcat /opt/tomcat/webapps/ /opt/tomcat/work/ /opt/tomcat/temp/ /opt/tomcat/logs/ && \
    chmod +x /opt/tomcat/bin/*\.sh

ADD tomcat-service.txt /etc/systemd/system/tomcat.service
RUN JAVA_HOME=$(update-java-alternatives -l | head -1 | awk '{print $3}') && \
    sed --in-place "s|Environment=JAVA_HOME=.*|Environment=JAVA_HOME=$JAVA_HOME|1" /etc/systemd/system/tomcat.service

RUN sed -i '44i <user username="admin" password="admin" roles="manager-gui,admin-gui"/>' /opt/tomcat/conf/tomcat-users.xml
RUN sed -i "19i <\!--" /opt/tomcat/webapps/manager/META-INF/context.xml && \
    sed -i "23i -->" /opt/tomcat/webapps/manager/META-INF/context.xml && \
    sed -i "19i <\!--" /opt/tomcat/webapps/host-manager/META-INF/context.xml && \
    sed -i "23i -->" /opt/tomcat/webapps/host-manager/META-INF/context.xml

CMD /opt/tomcat/bin/catalina.sh start && /bin/bash


