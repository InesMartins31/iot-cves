FROM ubuntu:18.04

RUN apt-get update && apt-get -y upgrade
RUN apt-get install -y git build-essential autoconf bison re2c libxml2-dev zlib1g-dev nginx wget php-common libpcre3
RUN apt-get install -y libargon2-0 libsodium23 libsodium-dev

# TZDATA
ENV DEBIAN_FRONTEND=noninteractive
RUN ln -fs /usr/share/zoneinfo/Europe/London /etc/localtime
RUN apt-get install -y tzdata
RUN dpkg-reconfigure --frontend noninteractive tzdata


RUN git clone https://github.com/php/php-src

# checkout the fix
RUN git -C php-src checkout ab061f95ca966731b1c84cf5b7b20155c0a1c06a

# checkout the commit previous to the fix
RUN git -C php-src checkout HEAD~1

# build php-fpm
#RUN cd php-src && ./buildconf --force && ./configure --enable-fpm --without-pear && make -j4 && make install

RUN wget https://packages.sury.org/php/pool/main/p/php7.2/php7.2-common_7.2.23-1%2B0~20191008.27%2Bdebian8~1.gbp021266_arm64.deb
RUN wget https://packages.sury.org/php/pool/main/p/php7.2/php7.2-json_7.2.23-1%2B0~20191008.27%2Bdebian8~1.gbp021266_arm64.deb
RUN wget https://packages.sury.org/php/pool/main/p/php7.2/php7.2-opcache_7.2.23-1%2B0~20191008.27%2Bdebian8~1.gbp021266_arm64.deb
RUN wget https://packages.sury.org/php/pool/main/p/php7.2/php7.2-readline_7.2.23-1%2B0~20191008.27%2Bdebian8~1.gbp021266_arm64.deb
RUN wget https://packages.sury.org/php/pool/main/p/php7.2/php7.2-cli_7.2.23-1%2B0~20191008.27%2Bdebian8~1.gbp021266_arm64.deb
RUN wget https://packages.sury.org/php/pool/main/p/php7.2/php7.2-fpm_7.2.23-1%2B0~20191008.27%2Bdebian8~1.gbp021266_arm64.deb
RUN wget http://ftp.us.debian.org/debian/pool/main/a/argon2/libargon2-1_0~20171227-0.2_arm64.deb
RUN wget https://packages.sury.org/php/pool/main/p/pcre3/libpcre3_8.41-1%2B0~20181207195800.1%2Bstretch~1.gbp97d153_arm64.deb
#RUN wget http://ftp.us.debian.org/debian/pool/main/p/pcre3/libpcre3_8.39-12_arm64.deb
RUN wget http://ftp.us.debian.org/debian/pool/main/a/apparmor/libapparmor1_2.13.2-10_arm64.deb

RUN dpkg -i libargon2-1_0~20171227-0.2_arm64.deb
# RUN dpkg -i libpcre3_8.39-12_arm64.deb
RUN dpkg -i libpcre3_8.41-1+0~20181207195800.1+stretch~1.gbp97d153_arm64.deb
RUN dpkg -i libapparmor1_2.13.2-10_arm64.deb
RUN dpkg -i php7.2-common_7.2.23-1+0~20191008.27+debian8~1.gbp021266_arm64.deb
RUN dpkg -i php7.2-json_7.2.23-1+0~20191008.27+debian8~1.gbp021266_arm64.deb
RUN dpkg -i php7.2-opcache_7.2.23-1+0~20191008.27+debian8~1.gbp021266_arm64.deb
RUN dpkg -i php7.2-readline_7.2.23-1+0~20191008.27+debian8~1.gbp021266_arm64.deb
RUN dpkg -i php7.2-cli_7.2.23-1+0~20191008.27+debian8~1.gbp021266_arm64.deb
RUN dpkg -i php7.2-fpm_7.2.23-1+0~20191008.27+debian8~1.gbp021266_arm64.deb

COPY php-fpm.conf /usr/local/etc/
COPY nginx.server.conf /etc/nginx/sites-enabled/default
COPY script.php /var/www/html/script.php
COPY entrypoint /

CMD /entrypoint