#!/bin/bash

sudo apt-get update
sudo apt-get install -y --no-install-recommends git build-essential autoconf bison re2c libxml2-dev zlib1g-dev nginx ca-certificates wget

git clone https://github.com/php/php-src && git -C php-src checkout ab061f95ca966731b1c84cf5b7b20155c0a1c06a -q && git -C php-src checkout HEAD~1 -q
cd php-src && ./buildconf --force && ./configure --enable-fpm --without-pear && make -j"$(nproc)" && sudo make install

sudo mkdir -p /var/www/html/php-fpm
sudo wget -q -O /usr/local/etc/php-fpm.conf https://raw.githubusercontent.com/neex/phuip-fpizdam/master/reproducer/php-fpm.conf
sudo wget https://raw.githubusercontent.com/neex/phuip-fpizdam/master/reproducer/nginx.server.conf -q -O /etc/nginx/sites-enabled/default
sudo touch /var/www/html/php-fpm/script.php
