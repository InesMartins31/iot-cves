#!/bin/bash

USER="www-data"

sudo apt update && sudo apt install -y openssh-server apt-utils iproute2 wget gcc cmake libc6-dev make

wget https://www.sudo.ws/dist/sudo-1.8.31p1.tar.gz --no-check-certificate
tar zxf sudo-1.8.31p1.tar.gz
cd sudo-1.8.31p1 || exit
./configure && make -j"$(nproc)" && sudo make install
cd ..

RUN usermod --shell /bin/bash "$USER"
RUN echo "$USER:qwerty" | chpasswd

cat <<EOF | sudo tee /usr/local/sbin/cleanup.sh
#!/bin/bash

getopt_simple()
{
    until [ -z "$1" ]
    do
      if [ ${1:0:2} = '--' ]
      then
          tmp=${1:2}               # Strip off leading '--' . . .
          parameter=${tmp%%=*}     # Extract name.
          value=${tmp##*=}         # Extract value.
          eval $parameter=$value
      fi
      shift
    done
}

target=/tmp

# Pass all options to getopt_simple().
getopt_simple $*

# list files to clean
echo "listing files in $target"
find "$target" -mtime 1
EOF

sudo chmod +x /usr/local/sbin/cleanup.sh
echo "$USER ALL=(root) NOPASSWD: /usr/local/sbin/cleanup.sh" | sudo tee -a /etc/sudoers

echo -e "Starting ssh\n\n"
/usr/sbin/sshd -D -p 8022
