#!/bin/bash

OLD_DIR=$(pwd)

sudo apt-get update && sudo apt-get install -y patch net-tools vim openssh-client openssh-server make gcc cmake apt-utils zlib1g-dev libssl-dev build-essential g++ git
git clone https://github.com/hackerhouse-opensource/cve-2018-10933 cve
cd cve && xz -d libssh-0.8.3.tar.xz && tar xf libssh-0.8.3.tar
cp -r "$OLD_DIR"/cve/libssh-0.8.3 "$OLD_DIR"/cve/exploit-libssh-0.8.3
cd "$OLD_DIR"/cve/libssh-0.8.3 || exit
mkdir build && cd build || exit
cmake .. && make -j"$(nproc)" && sudo make install
cd examples && make -j"$(nproc)"
cd "$OLD_DIR"/cve/exploit-libssh-0.8.3 || exit
patch -p0 < "$OLD_DIR"/cve/cve-2018-10933.patch
patch -p0 < "$OLD_DIR"/cve/server.patch
mkdir build && cd build && cmake ..
make -j"$(nproc)" && sudo make install
cd "$OLD_DIR" || exit
ssh-keygen -t dsa -f ssh_host_dsa_key -N ''
ssh-keygen -t rsa -b 2048 -f ssh_host_rsa_key -N ''
chmod +x "$OLD_DIR"/cve/exploit-libssh-0.8.3/build/examples/ssh_server_fork
cd || exit
