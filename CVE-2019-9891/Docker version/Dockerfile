FROM ubuntu:18.04
ARG DEBIAN_FRONTEND=noninteractive
ARG USER="guest"

RUN apt-get update && \
    apt-get install -y --no-install-recommends --allow-downgrades openssh-server apt-utils iproute2 wget gcc cmake libc6-dev make ca-certificates && \
    rm -rf /tmp/* /var/lib/apt/lists/* /var/tmp/*

RUN wget https://www.sudo.ws/dist/sudo-1.8.31p1.tar.gz && \
    tar zxf sudo-1.8.31p1.tar.gz && \
    cd sudo-1.8.31p1 || exit && \
    ./configure && make -j"$(nproc)" && make install

RUN useradd -m "$USER" -s /bin/bash && \
    mkdir -p /home/"$USER"/.ssh && \
    echo "$USER:$USER" | chpasswd

RUN mkdir -p /var/run/sshd && mkdir -p /root/.ssh && \
    sed --in-place 's/^\(UsePAM\|UseDNS\)/#\1/' /etc/ssh/sshd_config && echo "" >>/etc/ssh/sshd_config && \
    echo "UsePAM no" >>/etc/ssh/sshd_config && echo "UseDNS no" >>/etc/ssh/sshd_config && \
    sed -i "s/#PermitRootLogin.*/PermitRootLogin yes/1" /etc/ssh/sshd_config

ADD cleanup.sh /usr/local/sbin/cleanup.sh
RUN chmod +x /usr/local/sbin/cleanup.sh
RUN echo "$USER ALL=(root) NOPASSWD: /usr/local/sbin/cleanup.sh" >>/etc/sudoers

EXPOSE 22
CMD echo "Starting...\n" && \
    /usr/sbin/sshd -D -p 22
