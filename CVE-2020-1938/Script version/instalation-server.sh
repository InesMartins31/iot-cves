#!/bin/bash

sudo apt update && sudo apt install -y default-jdk
sudo groupadd tomcat
sudo useradd -s /bin/false -g tomcat -d /opt/tomcat tomcat

cd /tmp/ || exit
wget https://github.com/0nise/CVE-2020-1938/raw/master/apache-tomcat-8.5.32.zip
unzip apache-tomcat-8.5.32.zip
sudo mv apache-tomcat-8.5.32 /opt/tomcat
sudo chgrp -R tomcat /opt/tomcat
sudo chmod -R g+r /opt/tomcat/conf
sudo chmod g+x /opt/tomcat/conf
sudo chown -R tomcat /opt/tomcat/webapps/ /opt/tomcat/work/ /opt/tomcat/temp/ /opt/tomcat/logs/
sudo chmod +x /opt/tomcat/bin/*\.sh

JAVA_HOME=$(sudo update-java-alternatives -l | head -1 | awk '{print $3}')

cat <<'EOF' | sudo tee /etc/systemd/system/tomcat.service
[Unit]
Description=Apache Tomcat Web Application Container
After=network.target

[Service]
Type=forking

Environment=JAVA_HOME=
Environment=CATALINA_PID=/opt/tomcat/temp/tomcat.pid
Environment=CATALINA_HOME=/opt/tomcat
Environment=CATALINA_BASE=/opt/tomcat
Environment='CATALINA_OPTS=-Xms512M -Xmx1024M -server -XX:+UseParallelGC'
Environment='JAVA_OPTS=-Djava.awt.headless=true -Djava.security.egd=file:/dev/./urandom'

ExecStart=/opt/tomcat/bin/startup.sh
ExecStop=/opt/tomcat/bin/shutdown.sh

User=tomcat
Group=tomcat
UMask=0007
RestartSec=10
Restart=always

[Install]
WantedBy=multi-user.target
EOF

sudo sed --in-place "s|Environment=JAVA_HOME=.*|Environment=JAVA_HOME=$JAVA_HOME|1" /etc/systemd/system/tomcat.service

sudo sed -i '46i <user username="admin" password="password" roles="manager-gui,admin-gui"/>' /opt/tomcat/conf/tomcat-users.xml
sudo sed -i "19i <\!--" /opt/tomcat/webapps/manager/META-INF/context.xml
sudo sed -i "23i -->" /opt/tomcat/webapps/manager/META-INF/context.xml
sudo sed -i "19i <\!--" /opt/tomcat/webapps/host-manager/META-INF/context.xml
sudo sed -i "23i -->" /opt/tomcat/webapps/host-manager/META-INF/context.xml

sudo systemctl daemon-reload
sudo systemctl start tomcat
STATUS=$(sudo systemctl is-active tomcat)

if [ "$STATUS" = "active" ]; then
  sudo systemctl enable tomcat
  echo "Open browser at <Server IP>:8080"
else
  echo "An error occurred. Service not running."
fi

# https://github.com/00theway/Ghostcat-CNVD-2020-10487
# https://video.twimg.com/tweet_video/EROTWKIUwAEmIYQ.mp4
# https://www.digitalocean.com/community/tutorials/install-tomcat-9-ubuntu-1804
