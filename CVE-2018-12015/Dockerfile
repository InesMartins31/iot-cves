FROM ubuntu:18.04

ARG DEBIAN_FRONTEND=noninteractive

RUN apt-get update && apt-get install -y --no-install-recommends \
    openssh-server make gcc g++ wget libfile-copy-recursive-perl nano ca-certificates
RUN wget https://www.cpan.org/src/5.0/perl-5.26.2.tar.gz && \
    tar xf perl-5.26.2.tar.gz && \
    cd perl-5.26.2/  && \
    ./Configure -Dusesitecustomize -Dinc_version_list=none -Dprefix=/home/git/binary-com/perl -Dvendorprefix=/home/git/regentmarkets/cpan/local -Dvendorlib=/home/git/regentmarkets/cpan/local/lib/perl5 -Dvendorarch=/home/git/regentmarkets/cpan/local/lib/perl5/x86_64-linux -Duselargefiles -Dccflags="-DDEBIAN -D_FORTIFY_SOURCE=2 -g -O2 -fstack-protector --param=ssp-buffer-size=4 -Wformat -Werror=format-security" -Dldflags=" -Wl,-z,relro" -Dlddlflags="-shared -Wl,-z,relro" -Dcccdlflags="-fPIC" -Duse64bitint -Dman1ext=1 -Dman3ext=3perl -Dpager=/usr/bin/sensible-pager -Uafs -Ud_csh -Ud_ualarm -Uusesfio -Uusenm -Uuseithreads -Uusemultiplicity -Ui_libutil -DDEBUGGING=-g -Doptimize=-O2 -Duseshrplib -des  && \
    make -j $(nproc) && make install
RUN wget https://cpan.metacpan.org/authors/id/B/BI/BINGOS/ExtUtils-MakeMaker-7.44.tar.gz && \
    tar xf ExtUtils-MakeMaker-7.44.tar.gz  && \
    cd ExtUtils-MakeMaker-7.44  && \
    perl Makefile.PL && make -j $(nproc) && make install
RUN wget https://cpan.metacpan.org/authors/id/B/BI/BINGOS/Archive-Tar-2.26.tar.gz && \
    tar xf Archive-Tar-2.26.tar.gz  && \
    cd Archive-Tar-2.26  && \
    perl Makefile.PL && make -j $(nproc) && make install

ADD run.sh /root

# Fix ssh
RUN echo "root:qwerty" | chpasswd && \
    mkdir -p /var/run/sshd && \
    mkdir -p /root/.ssh && \
    sed --in-place 's/^\(UsePAM\|UseDNS\)/#\1/' /etc/ssh/sshd_config && \
    echo "" >>/etc/ssh/sshd_config && \
    echo "UsePAM no" >>/etc/ssh/sshd_config && \
    echo "UseDNS no" >>/etc/ssh/sshd_config && \
    sed -i "s/#PermitRootLogin.*/PermitRootLogin yes/1" /etc/ssh/sshd_config

WORKDIR /root

EXPOSE 22
CMD /usr/sbin/sshd -p 22 && /bin/bash
