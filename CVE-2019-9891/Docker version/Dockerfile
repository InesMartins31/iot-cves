FROM ubuntu:18.04
ARG DEBIAN_FRONTEND=noninteractive
ARG USER="www-data"

RUN apt-get update && apt-get -y --no-install-recommends --allow-downgrades install \
    openssh-server apt-utils iproute2 wget gcc cmake libc6-dev make

RUN wget https://www.sudo.ws/dist/sudo-1.8.31p1.tar.gz --no-check-certificate && \
    tar zxf sudo-1.8.31p1.tar.gz && \
    cd sudo-1.8.31p1 || exit && \
    ./configure && make -j"$(nproc)" && make install

RUN mkdir -p /var/run/sshd && mkdir -p /root/.ssh
RUN sed --in-place 's/^\(UsePAM\|UseDNS\)/#\1/' /etc/ssh/sshd_config && echo "" >>/etc/ssh/sshd_config
RUN echo "UsePAM no" >>/etc/ssh/sshd_config && echo "UseDNS no" >>/etc/ssh/sshd_config
RUN sed -i "s/#PermitRootLogin.*/PermitRootLogin yes/1" /etc/ssh/sshd_config

#RUN useradd -m "$USER" -s /bin/bash
RUN usermod --shell /bin/bash "$USER"
RUN echo "$USER:qwerty" | chpasswd
RUN echo "root:admin" | chpasswd

ADD cleanup.sh /usr/local/sbin/cleanup.sh
RUN chmod +x /usr/local/sbin/cleanup.sh
RUN echo "$USER ALL=(root) NOPASSWD: /usr/local/sbin/cleanup.sh" >>/etc/sudoers

EXPOSE 22
CMD ["/usr/sbin/sshd","-D","-p","22"]
