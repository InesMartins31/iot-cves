FROM ubuntu:20.04

ARG DEBIAN_FRONTEND=noninteractive

RUN apt-get update && \
    apt-get install -y --no-install-recommends wget tar build-essential zlib1g-dev libssl-dev python3 python3-pip python3-dev libffi-dev libssl-dev libpam0g-dev libselinux1-dev ca-certificates && \
    pip3 install paramiko && \
    rm -rf /tmp/* /var/lib/apt/lists/* /var/tmp/*

# Set SSH configs
RUN mkdir -p /var/lib/sshd && \
    chmod -R 700 /var/lib/sshd/ && \
    chown -R root:sys /var/lib/sshd/ && \
    useradd -r -U -d /var/lib/sshd/ -c "sshd privsep" -s /bin/false sshd

# OpenSSL
RUN wget https://www.openssl.org/source/old/1.0.2/openssl-1.0.2s.tar.gz && \
    tar xzf openssl-1.0.2s.tar.gz && \
    cd openssl-1.0.2s && \
    ./config && make -j $(nproc) && make install

#OpenSSH
RUN wget https://ftp.rnl.tecnico.ulisboa.pt/pub/OpenBSD/OpenSSH/portable/openssh-7.6p1.tar.gz && \
    tar xzf openssh-7.6p1.tar.gz && \
    cd openssh-7.6p1 && \
    ./configure --with-md5-passwords --with-pam --with-selinux --with-privsep-path=/var/lib/sshd/ --sysconfdir=/etc/ssh --with-ssl-dir=/usr/local/ssl && \
    make -j $(nproc) && make install

RUN echo "qwerty\nqwerty" | passwd && \
    sed -i "s/#PermitRootLogin.*/PermitRootLogin yes/1" /etc/ssh/sshd_config

ENV PORT 22

EXPOSE ${PORT}

CMD echo "My IP is $(hostname -I)\nStarting ssh at ${PORT}" && /usr/local/sbin/sshd -p ${PORT} -D
