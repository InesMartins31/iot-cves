#!/bin/bash

USER="guest"
sudo apt-get update && sudo apt-get install -y --no-install-recommends --allow-downgrades openssh-server apt-utils make
sudo mkdir -p /var/run/sshd && sudo mkdir -p /root/.ssh && echo "Packages installed"

sudo useradd -m "$USER" -s /bin/bash
sudo mkdir -p /home/"$USER"/.ssh
sudo chown -R "$USER:$USER" /home/"$USER"
echo "$USER:$USER" | sudo chpasswd
echo "$USER user successfully added"

wget https://www.sudo.ws/dist/sudo-1.8.27.tar.gz
tar zxvf sudo-1.8.27.tar.gz
cd sudo-1.8.27 || exit
sudo ./configure && sudo make -j"$(nproc)" && sudo make install
# echo "alias sudo='/usr/local/bin/sudo'" | sudo tee -a /home/"$USER"/.bashrc

# Add user to sudoers
echo "$USER ALL=(ALL,!root) NOPASSWD: /bin/bash" | sudo tee -a /etc/sudoers && echo "$USER user added to sudoers"

cd /etc/ssh || exit

# Take values from ARGS and modify sshd_config accordingly
#echo "root:qwerty" | chpasswd
echo "Successfully changed root password"
sudo sed --in-place 's/^\(UsePAM\|UseDNS\)/#\1/' sshd_config
echo "" | sudo tee -a sshd_config
echo "UsePAM no" | sudo tee -a sshd_config
echo "UseDNS no" | sudo tee -a sshd_config
echo "SSHD updated"

# sudo /usr/sbin/sshd -p 8022

IP=$(hostname -I | awk '{print $1}')
echo -e "\n\nNow run 'ssh $IP -l $USER' from your terminal. The password is '$USER'\n\n"
