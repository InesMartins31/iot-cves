FROM ubuntu:20.04

ARG DEBIAN_FRONTEND=noninteractive

RUN apt-get update && apt-get install -y --no-install-recommends git build-essential autoconf bison re2c libxml2-dev zlib1g-dev nginx ca-certificates wget
    
# CA problem fix (https://stackoverflow.com/a/35824116)
RUN mkdir /usr/local/share/ca-certificates/cacert.org && \
    wget -P /usr/local/share/ca-certificates/cacert.org http://www.cacert.org/certs/root.crt http://www.cacert.org/certs/class3.crt && \
    update-ca-certificates && \
    git config --global http.sslCAinfo /etc/ssl/certs/ca-certificates.crt

RUN git clone https://github.com/php/php-src

# checkout the fix
RUN git -C php-src checkout ab061f95ca966731b1c84cf5b7b20155c0a1c06a -q

# checkout the commit previous to the fix
RUN git -C php-src checkout HEAD~1 -q

# build php-fpm
RUN cd php-src && ./buildconf --force && ./configure --enable-fpm --without-pear && make -j"$(nproc)" && make install

RUN wget -q -P /usr/local/etc/ https://raw.githubusercontent.com/neex/phuip-fpizdam/master/reproducer/php-fpm.conf && \
    wget https://raw.githubusercontent.com/neex/phuip-fpizdam/master/reproducer/nginx.server.conf -q -O /etc/nginx/sites-enabled/default && \
    touch /var/www/html/script.php
    
CMD (nginx &) && ( php-fpm &) && tail -f /var/log/nginx/*.log

