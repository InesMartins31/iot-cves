FROM ubuntu:18.04
ARG DEBIAN_FRONTEND=noninteractive
ARG USER="guest"

RUN apt-get update && \
    apt-get install -y --no-install-recommends ruby ruby-dev zlib1g-dev wget openssh-server sudo && \
    rm -rf /tmp/* /var/lib/apt/lists/* /var/tmp/*

RUN wget https://rubygems.org/rubygems/rubygems-2.7.6.tgz && \
    tar zxf rubygems-2.7.6.tgz && \
    cd rubygems-2.7.6/ && \
    ruby setup.rb --no-document
RUN mkdir -p /tmp/dir && touch /tmp/dir/file
ADD builder.rb /

RUN mkdir -p /var/run/sshd && mkdir -p /root/.ssh && \
    useradd -m "$USER" -s /bin/bash && \
    mkdir -p /home/"$USER"/.ssh && \
    mv /builder.rb /home/"$USER" && \
    chown -R "$USER:$USER" /home/"$USER" && \
    echo "$USER:$USER" | chpasswd && \
    echo "$USER ALL=(ALL:ALL) NOPASSWD: /usr/bin/gem" >>/etc/sudoers
RUN sed --in-place 's/^\(UsePAM\|UseDNS\)/#\1/' /etc/ssh/sshd_config && echo "" >>/etc/ssh/sshd_config
RUN echo "UsePAM no" >>/etc/ssh/sshd_config && echo "UseDNS no" >>/etc/ssh/sshd_config
RUN echo "root:qwerty" | chpasswd

WORKDIR /home
EXPOSE 22
CMD echo "SSH server started" && /usr/sbin/sshd -D -p 22
