FROM ubuntu:20.04

ARG DEBIAN_FRONTEND=noninteractive

RUN apt-get update && \
    apt-get install -y --no-install-recommends wget make build-essential autoconf g++ git ca-certificates zlib1g-dev libssl-dev && \
    echo "root:qwerty" | chpasswd

WORKDIR /home

RUN wget https://raw.githubusercontent.com/kevinbackhouse/security-lab/mainline/SecurityExploits/libssh2/out_of_bounds_read_kex_CVE-2019-13115/server/home/diff.txt

RUN useradd guest -s /bin/bash && \
    mkdir -p /home/guest/.ssh && \
    chown -R guest:guest /home/guest/ && \
    echo "guest:guest" | chpasswd

# Create the sshd user
RUN mkdir /var/empty && \
    chown root:sys /var/empty && \
    chmod 755 /var/empty && \
    groupadd sshd && \
    useradd -g sshd -c 'sshd privsep' -d /var/empty -s /bin/false sshd

RUN git clone https://github.com/openssh/openssh-portable.git && \
    cd openssh-portable && \
    git checkout 21da87f439b48a85b951ef1518fe85ac0273e719 --quiet && \
    git apply /home/diff.txt && \
    autoreconf && ./configure && make -j$(nproc) && make install

CMD /usr/local/sbin/sshd -p 8022 -d
