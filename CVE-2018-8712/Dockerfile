FROM ubuntu:20.04

ARG DEBIAN_FRONTEND=noninteractive

WORKDIR /root

RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    libnet-ssleay-perl libauthen-pam-perl libio-pty-perl python python3 python3-pip wget libxml-parser-perl

# apt-show-versions
RUN rm /etc/apt/apt.conf.d/docker-gzip-indexes && \
    apt-get purge apt-show-versions && \
    rm /var/lib/apt/lists/*lz4 && \
    apt-get -o Acquire::GzipIndexes=false update && \
    apt-get install -y apt-show-versions

RUN pip3 install requests

RUN wget https://netix.dl.sourceforge.net/project/webadmin/webmin/1.880/webmin_1.880_all.deb && \
    dpkg -i webmin_1.880_all.deb && \
    apt-get --fix-broken install -y && \
    rm -rf /tmp/* /var/lib/apt/lists/* /var/tmp/*

RUN /usr/share/webmin/changepass.pl /etc/webmin root admin && \
    sed -i s/referers_none.*/referers_none=0/1 /etc/webmin/config

ARG USER="test"
RUN useradd $USER && \
    echo "$USER:qwerty" | chpasswd && \
    echo "$USER:x::::::::::::" | tee -a /etc/webmin/miniserv.users && \
    echo "$USER: syslog" | tee -a /etc/webmin/webmin.acl && \
    # Just to be certain
    echo "any=1\nsyslog=1" | tee /etc/webmin/syslog/$USER.acl

EXPOSE 10000

CMD /etc/webmin/start && echo "\nServer running...\n" && /bin/bash
