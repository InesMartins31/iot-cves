FROM ubuntu:18.04
WORKDIR /root
ARG DEBIAN_FRONTEND=noninteractive
RUN apt-get update && apt-get install -y patch net-tools vim \
    openssh-client openssh-server make gcc cmake apt-utils \
    zlib1g-dev libssl-dev build-essential g++ git
RUN git clone https://github.com/hackerhouse-opensource/cve-2018-10933 cve && \
    cd cve && \
    xz -d libssh-0.8.3.tar.xz && \
    tar xf libssh-0.8.3.tar
RUN cp -r /root/cve/libssh-0.8.3 /root/cve/exploit-libssh-0.8.3 && \
    cd /root/cve/libssh-0.8.3 &&\
    mkdir build &&\
    cd build &&\
    cmake .. &&\
    make -j"$(nproc)" &&\
    make install &&\
    cd examples &&\
    make -j"$(nproc)"
RUN cd /root/cve/exploit-libssh-0.8.3 &&\
    patch -p0 < /root/cve/cve-2018-10933.patch &&\
    patch -p0 < /root/cve/server.patch &&\
    mkdir build && \
    cd build && \
    cmake .. && \
    make -j"$(nproc)" &&\
    make install
RUN cd /root &&\
    ssh-keygen -t dsa -f ssh_host_dsa_key -N '' &&\
    ssh-keygen -t rsa -b 2048 -f ssh_host_rsa_key -N ''
EXPOSE 22
CMD echo "Waiting for connection...\n\n" && /root/cve/exploit-libssh-0.8.3/build/examples/ssh_server_fork -d /root/ssh_host_dsa_key -k /root/ssh_host_rsa_key -p 22 -v 0.0.0.0
