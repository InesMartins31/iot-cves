#!/bin/bash

ARCH=$(uname --m)

case $ARCH in
x86_64)
  ARCH="amd64"
  ;;

arm64 | aarch64)
  ARCH="arm64"
  ;;

*)
  echo "Unsupported architecture"
  exit
  ;;
esac

sudo apt install -y wget libltdl7

DOCKER_VERSION=$(sudo docker version | grep "Version:" | head -1 | awk '{print $2}' | cut -d "-" -f 1)
CONTAINERD_VERSION=$(sudo containerd -version | awk '{print $3}')

if [ ! "$CONTAINERD_VERSION" = "1.2.6" ]; then
  curl -O https://download.docker.com/linux/ubuntu/dists/xenial/pool/stable/"$ARCH"/containerd.io_1.2.6-3_"$ARCH".deb
  sudo dpkg -i containerd.io_1.2.6-3_"$ARCH".deb
  rm -f containerd.io_1.2.6-3_"$ARCH".deb
fi

if [ ! "$DOCKER_VERSION" = "18.06.0" ]; then
  curl -O https://download.docker.com/linux/ubuntu/dists/xenial/pool/stable/"$ARCH"/docker-ce_18.06.0~ce~3-0~ubuntu_"$ARCH".deb
  sudo dpkg -i docker-ce_18.06.0~ce~3-0~ubuntu_"$ARCH".deb
  rm -f docker-ce_18.06.0~ce~3-0~ubuntu_"$ARCH".deb
fi

sudo apt --fix-broken install -f -y

STATUS=$(sudo systemctl is-active docker)

if [ "$STATUS" = "active" ]; then
  git clone https://github.com/twistlock/RunC-CVE-2019-5736
  cd RunC-CVE-2019-5736/malicious_image_POC || exit
  sudo docker build -t cve-2019-5736 .
#  sudo docker run -it cve-2019-5736
#  cd ../.. && rm -rf RunC-CVE-2019-5736
fi
