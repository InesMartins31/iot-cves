#!/bin/bash

sudo apt-get update && sudo apt-get install -y --no-install-recommends wget make build-essential autoconf g++ git ca-certificates zlib1g-dev libssl-dev

# Add user for test
if ! id -u guest; then
  sudo useradd guest -s /bin/bash
  sudo mkdir -p /home/guest/.ssh
  sudo chown -R guest:guest /home/guest/
  echo "guest:guest" | sudo chpasswd
fi

cd /tmp/ || exit
git clone https://github.com/openssh/openssh-portable.git
cd openssh-portable || exit
git checkout 21da87f439b48a85b951ef1518fe85ac0273e719
wget --no-check-certificate https://raw.githubusercontent.com/kevinbackhouse/security-lab/master/SecurityExploits/libssh2/out_of_bounds_read_kex_CVE-2019-13115/server/home/diff.txt
git apply diff.txt
autoreconf && ./configure && make -j && make install
ssh-keygen -t rsa -b 4096 -f /tmp/file -N "" -q 2>/dev/null <<< y >/dev/null
cd /tmp || exit
