FROM ubuntu:18.04

WORKDIR /home

ARG DEBIAN_FRONTEND=noninteractive
ARG USER="guest"

RUN apt-get update && \
    apt-get install -y --no-install-recommends --allow-downgrades openssh-server \
    apt-utils iproute2 wget gcc cmake libc6-dev make ca-certificates && \
    rm -rf /tmp/* /var/lib/apt/lists/* /var/tmp/*

RUN wget https://www.sudo.ws/dist/sudo-1.8.27.tar.gz && \
    tar zxvf sudo-1.8.27.tar.gz && \
    cd sudo-1.8.27 || exit && \
    ./configure && make -j"$(nproc)" && make install

# Set SSH details
RUN mkdir -p /var/run/sshd && mkdir -p /root/.ssh && \
    useradd -m "$USER" -s /bin/bash && \
    mkdir -p /home/"$USER"/.ssh && \
    echo "$USER:$USER" | chpasswd && \
    sed --in-place 's/^\(UsePAM\|UseDNS\)/#\1/' /etc/ssh/sshd_config && \
    echo "" | tee -a /etc/ssh/sshd_config && \
    echo "UsePAM no" | tee -a /etc/ssh/sshd_config && \
    echo "UseDNS no" | tee -a /etc/ssh/sshd_config

RUN echo "$USER ALL=(ALL,!root) NOPASSWD: /bin/bash" | tee -a /etc/sudoers && \
    echo "root:qwerty" | chpasswd

EXPOSE 22

CMD ["/usr/sbin/sshd","-D","-p","22"]