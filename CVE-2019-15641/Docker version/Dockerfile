FROM ubuntu:20.04
ARG DEBIAN_FRONTEND=noninteractive
WORKDIR /root
RUN apt-get update && \
    apt-get install -y libnet-ssleay-perl libauthen-pam-perl libio-pty-perl python python3 python3-pip wget libxml-parser-perl && \
    apt-get --fix-broken install -f -y

RUN rm /etc/apt/apt.conf.d/docker-gzip-indexes && \
    apt-get purge apt-show-versions && \
    rm /var/lib/apt/lists/*lz4 && \
    apt-get -o Acquire::GzipIndexes=false update && \
    apt-get install apt-show-versions -y

RUN pip3 install requests

RUN wget https://netcologne.dl.sourceforge.net/project/webadmin/webmin/1.900/webmin_1.900_all.deb && \
    dpkg -i webmin_1.900_all.deb && \
    apt-get --fix-broken install -y

RUN /usr/share/webmin/changepass.pl /etc/webmin root admin
RUN sed --in-place s/passwd_mode=.*/passwd_mode=2/1 /etc/webmin/miniserv.conf
RUN echo "referer=1" >> /etc/webmin/config

ARG USER="test"
RUN useradd $USER
RUN echo "$USER:qwerty" | chpasswd
RUN echo "$USER:x::::::::::::" | tee -a /etc/webmin/miniserv.users
RUN echo "rpc=1" | tee -a /etc/webmin/test.acl

EXPOSE 10000

CMD /usr/bin/perl /usr/share/webmin/miniserv.pl /etc/webmin/miniserv.conf && echo "\nServer running...\n" && /bin/bash
