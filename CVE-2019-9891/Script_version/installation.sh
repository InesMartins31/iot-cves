#!/bin/bash

USER="guest"

sudo apt update &&
  sudo apt install -y --no-install-recommends openssh-server apt-utils iproute2 wget gcc cmake libc6-dev make ca-certificates

sudo mkdir -p /var/run/sshd && sudo mkdir -p /root/.ssh

wget https://www.sudo.ws/dist/sudo-1.8.31p1.tar.gz
tar zxf sudo-1.8.31p1.tar.gz
cd sudo-1.8.31p1 || exit
sudo ./configure && sudo make -j"$(nproc)" && sudo make install
cd ..

sudo useradd $USER -s /bin/bash && sudo mkdir -p /home/$USER/.ssh &&
  sudo chown -R $USER:$USER /home/$USER/ && echo "$USER:$USER" | sudo chpasswd

cat <<EOF | sudo tee /usr/local/sbin/cleanup.sh
#!/bin/bash

getopt_simple()
{
    until [ -z "\$1" ]
    do
      if [ \${1:0:2} = '--' ]
      then
          tmp=\${1:2}               # Strip off leading '--' . . .
          parameter=\${tmp%%=*}     # Extract name.
          value=\${tmp##*=}         # Extract value.
          eval \$parameter=\$value
      fi
      shift
    done
}

target=/tmp

# Pass all options to getopt_simple().
getopt_simple \$*

# list files to clean
echo "listing files in \$target"
find "\$target" -mtime 1
EOF

sudo chmod +x /usr/local/sbin/cleanup.sh
echo "$USER ALL=(root) NOPASSWD: /usr/local/sbin/cleanup.sh" | sudo tee -a /etc/sudoers

sudo sed --in-place 's/^\(UsePAM\|UseDNS\)/#\1/' /etc/ssh/sshd_config
echo -e "UsePAM no\nUseDNS no\n" | sudo tee -a /etc/ssh/sshd_config

echo -e "Starting ssh\n\n"
#/usr/bin/sshd -D -p 8022
sudo "$(whereis sshd | awk '{print $2}')" -d -p 8022
