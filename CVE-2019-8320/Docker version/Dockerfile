FROM ubuntu:18.04
ARG DEBIAN_FRONTEND=noninteractive
RUN apt-get update && apt-get install -y --no-install-recommends ruby ruby-dev zlib1g-dev wget openssh-server sudo

ARG USER="guest"
RUN mkdir -p /var/run/sshd && mkdir -p /root/.ssh && \
    useradd -m "$USER" -s /bin/bash && \
    mkdir -p /home/"$USER"/.ssh && \
    echo "$USER:$USER" | chpasswd && \
    echo "$USER ALL=(ALL:ALL) NOPASSWD: /usr/bin/gem" >>/etc/sudoers
RUN sed --in-place 's/^\(UsePAM\|UseDNS\)/#\1/' /etc/ssh/sshd_config && echo "" >>/etc/ssh/sshd_config
RUN echo "UsePAM no" >>/etc/ssh/sshd_config && echo "UseDNS no" >>/etc/ssh/sshd_config
RUN echo "root:qwerty" | chpasswd

RUN wget https://rubygems.org/rubygems/rubygems-2.7.6.tgz && \
    tar zxf rubygems-2.7.6.tgz && \
    cd rubygems-2.7.6/ && \
    ruby setup.rb --no-document
RUN mkdir -p /tmp/dir && touch /tmp/dir/file
ADD builder.rb /home/guest
WORKDIR /home
EXPOSE 22
CMD ["/usr/sbin/sshd","-D","-p","22"]
