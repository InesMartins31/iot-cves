FROM ubuntu:18.04
WORKDIR /home
ARG DEBIAN_FRONTEND=noninteractive
ARG USER="guest"
RUN apt-get update && apt-get -y --no-install-recommends --allow-downgrades install \
    openssh-server apt-utils iproute2 wget gcc cmake libc6-dev make
RUN wget https://www.sudo.ws/dist/sudo-1.8.27.tar.gz --no-check-certificate && \
    tar zxvf sudo-1.8.27.tar.gz && \
    cd sudo-1.8.27 || exit && \
    ./configure && make -j"$(nproc)" && make install
RUN mkdir -p /var/run/sshd && mkdir -p /root/.ssh
RUN useradd -m "$USER" -s /bin/bash
RUN mkdir -p /home/"$USER"/.ssh
RUN echo "$USER:$USER" | chpasswd
RUN echo "$USER ALL=(ALL,!root) NOPASSWD: /bin/bash" >>/etc/sudoers
RUN echo "root:qwerty" | chpasswd
RUN sed --in-place 's/^\(UsePAM\|UseDNS\)/#\1/' /etc/ssh/sshd_config && echo "" >>/etc/ssh/sshd_config
RUN echo "UsePAM no" >>/etc/ssh/sshd_config && echo "UseDNS no" >>/etc/ssh/sshd_config
#RUN export IP=$(ip address show eth0 | grep "inet" | head -1 | awk '{print $2}' | cut -d "/" -f 1) && \
#    echo "IP: $IP" && \
#    echo -e "\n\nNow run 'ssh <IP of server> -l $USER -p 8022' from your terminal. The password is '$USER'\n\n"
EXPOSE 22
CMD ["/usr/sbin/sshd","-D","-p","22"]